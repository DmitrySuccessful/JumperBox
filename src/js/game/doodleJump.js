import{ParticleSystem}from"./particles.js";const W=400,H=600,PW=40,PH=40,PLW=80,PLH=15,G=.5,J=-12,S=5;class PowerUp{constructor(x,y,t){this.x=x;this.y=y;this.width=30;this.height=30;this.type=t;this.collected=false}draw(c){if(this.collected)return;c.fillStyle=this.type==="spring"?"#FF4081":"#FFC107";c.fillRect(this.x,this.y,this.width,this.height);c.fillStyle="#fff";c.font="20px Arial";c.fillText(this.type==="spring"?"↑":"★",this.x+8,this.y+22)}}class Player{constructor(x,y){this.x=x;this.y=y;this.width=PW;this.height=PH;this.vx=0;this.vy=0;this.jumping=false;this.pt=0;this.hp=false}update(){this.vy+=G;this.x+=this.vx;this.y+=this.vy;if(this.x+this.width<0)this.x=W;else if(this.x>W)this.x=-this.width;if(this.pt>0){this.pt--;if(this.pt===0)this.hp=false}}draw(c){c.fillStyle=this.hp?"#FFD700":"#4CAF50";c.fillRect(this.x,this.y,this.width,this.height);c.fillStyle="#000";c.beginPath();c.arc(this.x+15,this.y+15,3,0,Math.PI*2);c.arc(this.x+25,this.y+15,3,0,Math.PI*2);c.fill();c.beginPath();c.arc(this.x+20,this.y+25,5,0,Math.PI);c.stroke()}jump(f=J){this.vy=f;this.jumping=true}powerUp(t){this.hp=true;this.pt=300;if(t==="spring")this.jump(J*1.5)}}class Platform{constructor(x,y,t="normal"){this.x=x;this.y=y;this.width=PLW;this.height=PLH;this.type=t;this.broken=false;this.d=1;this.s=t==="moving"?2:0;if(Math.random()<.1)this.powerUp=new PowerUp(this.x+this.width/2-15,this.y-35,Math.random()<.5?"spring":"star")}update(){if(this.type==="moving"){this.x+=this.s*this.d;if(this.x<=0||this.x+this.width>=W)this.d*=-1;if(this.powerUp&&!this.powerUp.collected)this.powerUp.x=this.x+this.width/2-15}}draw(c){if(this.broken)return;switch(this.type){case"normal":c.fillStyle="#795548";break;case"moving":c.fillStyle="#2196F3";break;case"breakable":c.fillStyle="#FF5722";break}c.fillRect(this.x,this.y,this.width,this.height);if(this.powerUp&&!this.powerUp.collected)this.powerUp.draw(c)}}class Game{constructor(c){this.canvas=c;this.ctx=c.getContext("2d");this.score=0;this.hs=parseInt(localStorage.getItem("hs"))||0;this.go=false;this.platforms=[];this.particles=new ParticleSystem;this.d=1;this.init();this.events()}init(){this.player=new Player(W/2,H-100);this.platforms=[];this.score=0;this.go=false;this.cy=0;this.d=1;for(let i=0;i<7;i++)this.genPlatform(i*100)}genPlatform(y){const t=["normal","moving","breakable"];const type=Math.random()<.7?"normal":t[Math.floor(Math.random()*t.length)];const x=Math.random()*(W-PLW);this.platforms.push(new Platform(x,y,type))}update(){if(this.go)return;this.player.update();this.particles.update();this.d=1+Math.floor(this.score/1000);if(this.player.y<H/2){const d=H/2-this.player.y;this.cy+=d;this.player.y+=d;this.platforms.forEach(p=>{p.y+=d;if(p.powerUp)p.powerUp.y+=d});this.platforms=this.platforms.filter(p=>p.y<H);while(this.platforms.length<7)this.genPlatform(this.platforms[this.platforms.length-1].y-100);this.score=Math.floor(this.cy/100)}this.platforms.forEach(p=>{p.update();if(p.powerUp&&!p.powerUp.collected&&this.player.x+this.player.width>p.powerUp.x&&this.player.x<p.powerUp.x+p.powerUp.width&&this.player.y+this.player.height>p.powerUp.y&&this.player.y<p.powerUp.y+p.powerUp.height){p.powerUp.collected=true;this.player.powerUp(p.powerUp.type)}if(!p.broken&&this.player.vy>0&&this.player.x+this.player.width>p.x&&this.player.x<p.x+p.width&&this.player.y+this.player.height>p.y&&this.player.y+this.player.height<p.y+p.height+10){if(p.type==="breakable")p.broken=true;this.player.jump();this.particles.createJumpEffect(this.player.x,this.player.y+this.player.height)}});if(this.player.y>H){this.go=true;if(this.score>this.hs){this.hs=this.score;localStorage.setItem("hs",this.hs)}}}draw(){this.ctx.clearRect(0,0,W,H);this.ctx.fillStyle="#E0F7FA";this.ctx.fillRect(0,0,W,H);this.platforms.forEach(p=>p.draw(this.ctx));this.particles.draw(this.ctx);this.player.draw(this.ctx);this.ctx.fillStyle="#000";this.ctx.font="20px Arial";this.ctx.fillText(`Score: ${this.score}`,10,30);this.ctx.fillText(`High Score: ${this.hs}`,10,60);this.ctx.fillText(`Level: ${this.d}`,W-100,30);if(this.go){this.ctx.fillStyle="rgba(0,0,0,0.5)";this.ctx.fillRect(0,0,W,H);this.ctx.fillStyle="#fff";this.ctx.font="40px Arial";this.ctx.fillText("Game Over!",W/2-100,H/2-40);this.ctx.font="20px Arial";this.ctx.fillText("Press SPACE to restart",W/2-100,H/2+20);this.ctx.fillText(`Final Score: ${this.score}`,W/2-60,H/2+60)}}events(){window.addEventListener("keydown",e=>{if(this.go&&e.code==="Space"){this.init();return}switch(e.code){case"ArrowLeft":this.player.vx=-S;break;case"ArrowRight":this.player.vx=S;break}});window.addEventListener("keyup",e=>{if(e.code==="ArrowLeft"&&this.player.vx<0)this.player.vx=0;if(e.code==="ArrowRight"&&this.player.vx>0)this.player.vx=0})}loop(){this.update();this.draw();requestAnimationFrame(()=>this.loop())}}export{Game};
